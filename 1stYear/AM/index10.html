<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance System For CSE(DS)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #eef2f7; margin: 0; padding: 0; }
    header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; }
    .container { max-width: 1100px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; color: #2c3e50; }
    .hidden { display: none; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #34495e; color: white; position: relative; }
    tr:nth-child(even) { background-color: #f8f9fb; }
    tr:hover { background-color: #f1f5f9; }
    button { margin: 10px 5px; padding: 10px 18px; border: none; border-radius: 4px; background-color: #3498db; color: white; cursor: pointer; }
    button:hover { background-color: #2980b9; }
    .danger-btn { background-color: #e74c3c; }
    .danger-btn:hover { background-color: #c0392b; }
    select, input[type="text"], input[type="password"], input[type="date"], input[type="number"] { padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
    input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .muted { color:#6b7280; font-size: 0.95rem; }
    .notice { background:#fff3cd; color:#856404; border:1px solid #ffeeba; padding:10px; border-radius:6px; margin:10px 0; }
    .success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; padding:10px; border-radius:6px; margin:10px 0; }
    .error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; padding:10px; border-radius:6px; margin:10px 0; }
    small { display:block; color:#6b7280 }
    #qr-box { display:flex; gap:16px; align-items:flex-start; }
    #qrcode { padding:8px; background:#fff; border:1px solid #e5e7eb; border-radius:8px; }
    code.kbd { background:#111827; color:#f9fafb; padding:2px 6px; border-radius:4px; }
    
    /* Auto-update indicators */
    .auto-update-indicator { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      z-index: 1000; 
      padding: 8px 16px; 
      border-radius: 20px; 
      font-size: 0.85rem;
      font-weight: 500;
    }
    .auto-update-indicator.connected { 
      background: #d4edda; 
      color: #155724; 
      border: 1px solid #c3e6cb; 
    }
    .auto-update-indicator.updating { 
      background: #fff3cd; 
      color: #856404; 
      border: 1px solid #ffeeba; 
    }
    .auto-update-indicator.error { 
      background: #f8d7da; 
      color: #721c24; 
      border: 1px solid #f5c6cb; 
    }
    
    .pulse-animation {
      animation: pulse 0.5s ease-in-out;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    
    .updated-cell {
      background-color: #d4edda !important;
      transition: background-color 2s ease-out;
    }
    
    .last-updated {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 10px;
    }

    /* Select All button styling */
   .select-all-btn {
  background: #3498db;      /* Modern blue */
  color: white;
  border: none;
  border-radius: 6px;
  /* padding: 3px 8px; */
  margin-left: 5px;
  font-size: 12px;
  cursor: pointer;
  transition:  0.2s ease;
}

.select-all-btn:hover {
  background: #2980b9;      /* Darker blue on hover */
}

.select-all-btn:active {
  background: #1f5c87;      /* Even darker when clicked */
}

.subject-header {
  white-space: nowrap;
}

    
    .select-all-btn.deselect {
      background-color: #e67e22;
    }
    
    .select-all-btn.deselect:hover {
      background-color: #d35400;
    }

    /* Add extra space for select all buttons */
    .table-container {
      position: relative;
      padding-bottom: 45px;
    }

    /* Style for subject headers */
    .subject-header {
      position: relative;
      padding-bottom: 40px;
    }
  </style>
</head>
<body>
<header style="display:flex; justify-content:space-between; align-items:center; padding:20px; background:#2c3e50; color:white;">
  <h1 style="margin:0;">Attendance System For CSE(DS)</h1>
  
</header>


<!-- Auto-update status indicator -->
<div id="auto-update-status" style="display: none;" class="auto-update-indicator connected">
  ðŸŸ¢ Live Updates Active
</div>

<div class="container">

  <!-- LOGIN -->
  <div id="login-section">
    <h2>Secure Login</h2>
    <p class="muted">Sign in with the email that was added to <strong>Firebase Authentication</strong>.</p>
    <div class="row">
      <label style="min-width:280px">Email:<br/><input type="text" id="username" placeholder="Enter email" autocomplete="username" /></label>
      <label style="min-width:280px">Password:<br/><input type="password" id="password" placeholder="Enter password" autocomplete="current-password" /></label>
    </div>
      <!-- <div class="row">
      <div class="g-recaptcha" data-sitekey="6Lf3HqYrAAAAAAMj597dHly9qhUC5LF-BKdemUnN"></div>
    </div>   -->
    <div class="row">
      <button id="login-btn">Login</button>
      <button id="forgot-btn" class="muted">Forgot password</button>
    </div>
    <div id="login-feedback" style="min-height:1.25rem; margin-top:8px"></div>
    <div id="login-troubleshoot" class="notice" style="display:none;">
      <strong>Troubleshooting tips</strong>
      <ul>
        <li>Make sure you are using the <em>exact</em> email created in Authentication.</li>
        <li>If you get <code>auth/user-not-found</code>, the email is not registered (add user in Firebase Console â†’ Authentication).</li>
        <li>If you get <code>auth/wrong-password</code>, use the <em>Forgot password</em> button to reset it.</li>
        <li>If you still see errors, check the browser console and the Firebase Authentication &amp; Firestore rules.</li>
      </ul>
    </div>
  </div>

  <!-- APP -->
  <div id="attendance-section" class="hidden">
    

    <div id="user-role-info" class="muted" style="margin-bottom:10px"></div>
    <div id="missing-role" class="error" style="display:none;"></div>

    <div class="row">
      
      <label>Saved Records: <select required id="saved-dates"></select></label>
      <button id="logout-btn" class="danger-btn">Logout</button>
      <button onclick="window.location.href='private.html'" 
          style="padding:10px 18px; border:none; border-radius:8px; background-color:#3498db; color:white; cursor:pointer; font-weight:600; font-size:1rem;">
    Click to Check your Attendance
  </button>
    </div>

    <!-- TEACHER: Start QR Session -->
       
    <div id="qr-session-box" class="notice" style="display:none; margin-top:12px;">
      <div class="row" style="justify-content: space-between; align-items: center; ">
      <!-- <h2 style="margin: 0;">Mark Attendance</h2> -->
       <h2 style="margin: 0;">Instructions to Mark Attendance:</h2>
    </div>
    
    <p >Step1: Select a Saved Record. If the required record is not found, Select Day, Date and Subject. <br>
      Step2: Start taking attendance by ticking the boxes. If the Required Subject is not found then add the subject.<br> 
      Step3(Important): Click "Save Attendance" to save the record.<br>     
    </p>
      
      <!-- <div class="row">
        <strong>QR + Geolocation session (teacher)</strong>
      </div> -->
      <div class="row">
        <label>Select Day: <select id="day-select"></select></label>
      <label>Date: <input type="date" id="date-select"></label>
        <label>Subject: <select id="subject-select"></select></label>
        <button onclick="window.location.href='students.html'" 
          style="padding:10px 18px; border:none; border-radius:8px; background-color:#3498db; color:white; cursor:pointer; font-weight:600; font-size:1rem;">  Student Attendance Overview
</button>

  <button onclick="window.location.href='sem.html'" 
          style="padding:10px 18px; border:none; border-radius:8px; background-color:#3498db; color:white; cursor:pointer; font-weight:600; font-size:1rem;">
    Classes taken in the Semester
  </button>
  <button onclick="window.location.href='absent.html'" 
          style="padding:10px 18px; border:none; border-radius:8px; background-color:#3498db; color:white; cursor:pointer; font-weight:600; font-size:1rem;">
    Check Absent Students
  </button>
        <!-- <label>Radius (m): <input id="radius-input" type="number" min="5" max="200" step="1" value="35" /></label>
        <label>Expires in (min): <input id="expire-mins" type="number" min="1" max="15" step="1" value="3" /></label> -->
        <!-- <button id="set-class-here">Use my current location</button>
        <button id="start-qr-btn">Start QR Session</button>
        <button id="end-qr-btn" class="danger-btn" style="display:none;">End Session</button> -->
      </div>
      <div id="add-class-section" class="row">
  <input type="text" id="new-class-name" placeholder="Enter new class/subject">
  <button id="add-class-btn">Add Class</button>
  <button id="remove-class-btn" class="danger-btn">Remove Selected Subject</button>

      <div id="teacher-buttons" class="row">
      <button id="save-btn">Save Attendance</button>
      <button id="export-btn">Export as CSV</button>
      <button id="toggle-auto-update">ðŸ”„ Auto-Update: ON</button>
    </div>
    </div>
      <div id="qr-box" class="hidden">
        <div id="qrcode"></div>
        <!-- <div>
          <div id="qr-info" class="muted"></div>
          <small>Students: open your camera, scan the QR, tap the link, allow location, done.</small>
        </div> -->
      </div>
    </div>
    <!-- Add class input (hidden for viewers) -->
    

    <!-- STUDENT: Token detected -->
    <!-- <div id="scan-status" class="notice hidden"></div>
     <h1>Mark Attendance</h1>
  <input type="text" id="qrInput" placeholder="Paste scanned QR content" />
  <button onclick="markAttendance()">Submit</button> -->

    <div class="table-container">
      <table id="attendance-table">    
        <thead>
          <tr id="table-header"></tr>
        </thead>
        <tbody id="attendance-body"></tbody>
      </table>
    </div>

    <div class="last-updated" id="last-updated-info"></div>

    <div id="teacher-buttons" class="row">
      <button id="save-btn2">Save Attendance</button>
      <button id="export-btn2">Export as CSV</button>
      <button id="toggle-auto-update">ðŸ”„ Auto-Update: ON</button>
    </div>
  </div>
</div>

<!-- QR library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-MnQnQf9O9Vf6xNmKxN0h7Qb0sN7c5F6aFqbKp1q5mHcK2lYt8nqf3zZbX2p8n2l0J3O7yZQ0Nw7Qx9mDxQ8Zig==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Google reCAPTCHA -->
  <!-- <script src="https://www.google.com/recaptcha/api.js" async defer></script>   -->

<script type="module">

    // Replace with your PC's local IP
const pcIP = "192.168.1.5"; // Change to your actual IPv4 address
const port = 5500;
const filePath = "index.html"; // Your attendance page

const qrData = `http://${pcIP}:${port}/${filePath}`;
// new QRCode(document.getElementById("qrcode"), qrData);      //uncomment this line to generate QR code for the attendance page

  /*************************************
   * Firebase SDKs (v9 modular)
   *************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

  const firebaseConfig = {
  apiKey: "AIzaSyCRFMKHulz5a1cmRMvrKMHEmjQH-Sdw1LU",
  authDomain: "styearamattendance.firebaseapp.com",
  projectId: "styearamattendance",
  storageBucket: "styearamattendance.firebasestorage.app",
  messagingSenderId: "841544576901",
  appId: "1:841544576901:web:0579e5f03f59d2ce011eec",
  measurementId: "G-F27T3JXJYN"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /*************************************
   * CONFIG: classroom defaults (override via "Use my current location")
   *************************************/
  //let CLASS_LAT = 17.385044;   // TODO: set your classroom latitude
 // let CLASS_LON = 78.486671;   // TODO: set your classroom longitude

  //let CLASS_LAT = 17.515338;   
 // let CLASS_LON =78.199101;
  let CLASS_LAT =17.4521792;   
  let CLASS_LON =78.3418871;
  let CLASS_RADIUS_METERS_DEFAULT = 35;

  /*************************************
   * Data
   *************************************/
  const students = [
   "BT25AM02 - SEETHALA SAI TASHVI",
"BT25AM04 - TADIKONDA YUVA TEJAS",
"BT25AM05 - DASARI JAGADEEP",
"BT25AM06 - SATYANARAYANA NIDHI",
"BT25AM07 - CHERUKURI AKSHAY VARMA",
"BT25AM08 - VUNNAM SAKETH NANDAN",
"BT25AM09 - BALAGANI SHANMUKH",
"BT25AM10 - MAHAKALA AKSHAYA",
"BT25AM11 - SINGIREDDY SARASIJ REDDY",
"BT25AM12 - MOOLA MUKESH REDDY",
"BT25AM13 - AMSHITHA KUKKADAPU",
"BTC5AM14 - KANDIMALLA MANI DEEP REDDY",
"BT25AM15 - PAKTUR TEJAS CHANDRA SINGH",
"BT25AM16 - T V SAI ANANDITA",

  ];

  const subjectsByDay = {
    'Monday': ['M&C', 'English Theory', 'PPS Theory', 'EDC','Sports/Library'],
    'Tuesday': ['M&C', 'EC', 'English Theory', 'English-Lab'],
    'Wednesday': ['M&C', 'EC', 'Engineering Workshop', 'IPR'],
    'Thursday': ['DA-Lab','PPS-Lab'],
    'Friday': ['M&C', 'PPS Theory','EDC','EDC/M&C Assignments'],
    'Saturday': ['']
  };

  /*************************************
   * DOM
   *************************************/
 const $ = id => document.getElementById(id);

  const loginSection = $("login-section");
  const attendanceSection = $("attendance-section");
  const loginFeedback = $("login-feedback");
  const loginTroubleshoot = $("login-troubleshoot");
  const daySelect = $("day-select");
  const dateSelect = $("date-select");
  const savedDates = $("saved-dates");
  const addClassSection = $("add-class-section");
  const teacherButtons = $("teacher-buttons");
  const tableHeader = $("table-header");
  const tbody = $("attendance-body");
  const loginBtn = $("login-btn");
  const forgotBtn = $("forgot-btn");
  const logoutBtn = $("logout-btn");
  const addClassBtn = $("add-class-btn");
  const saveBtn = $("save-btn");
  const exportBtn = $("export-btn");
  const saveBtn2 = $("save-btn2");
  const exportBtn2 = $("export-btn2");
  const userRoleInfo = $("user-role-info");
  const missingRole = $("missing-role");
  const autoUpdateStatus = $("auto-update-status");
  const lastUpdatedInfo = $("last-updated-info");
  const toggleAutoUpdateBtn = $("toggle-auto-update");

  // QR session UI
  const qrSessionBox = $("qr-session-box");
  const subjectSelect = $("subject-select");
  const radiusInput = $("radius-input");
  const expireMinsInput = $("expire-mins");
  const setClassHereBtn = $("set-class-here");
  const startQrBtn = $("start-qr-btn");
  const endQrBtn = $("end-qr-btn");
  const qrBox = $("qr-box");
  const qrInfo = $("qr-info");
  const scanStatus = $("scan-status");

  let currentRole = null; // 'teacher' | 'viewer'
  let activeSessionToken = null;
  let activeSessionRef = null;
  let qrcode = null;

  /*************************************
   * AUTO-UPDATE SYSTEM
   *************************************/
  let autoUpdateEnabled = true;
  let currentDocListener = null;
  let currentAttendanceDoc = null;
  let lastKnownData = null;

  // Toggle auto-update functionality
  toggleAutoUpdateBtn.addEventListener('click', () => {
    autoUpdateEnabled = !autoUpdateEnabled;
    
    if (autoUpdateEnabled) {
      toggleAutoUpdateBtn.innerHTML = 'ðŸ”„ Auto-Update: ON';
      toggleAutoUpdateBtn.style.backgroundColor = '#28a745';
      startAutoUpdate();
      updateStatusIndicator('connected', 'ðŸŸ¢ Live Updates Active');
    } else {
      toggleAutoUpdateBtn.innerHTML = 'â¸ï¸ Auto-Update: OFF';
      toggleAutoUpdateBtn.style.backgroundColor = '#6c757d';
      stopAutoUpdate();
      updateStatusIndicator('error', 'ðŸ”´ Live Updates Paused');
    }
  });

  function updateStatusIndicator(status, text) {
    autoUpdateStatus.className = `auto-update-indicator ${status}`;
    autoUpdateStatus.textContent = text;
    
    // Auto-hide after 3 seconds for temporary messages
    if (status === 'updating') {
      setTimeout(() => {
        if (autoUpdateEnabled) {
          updateStatusIndicator('connected', 'ðŸŸ¢ Live Updates Active');
        }
      }, 3000);
    }
  }

  function startAutoUpdate() {
    if (!autoUpdateEnabled) return;
    
    const day = daySelect.value;
    const date = dateSelect.value;
    if (!day || !date) return;
    
    stopAutoUpdate(); // Clean up any existing listener
    
    const docId = `${day}_${date}`;
    currentAttendanceDoc = docId;
    
    // In the auto-update section, replace the existing onSnapshot code with this:
try {
  currentDocListener = onSnapshot(
    doc(db, 'attendance', docId),
    (docSnapshot) => {
      if (!autoUpdateEnabled) return;
      
      updateStatusIndicator('updating', 'ðŸ”„ Updating...');
      
      if (docSnapshot.exists()) {
        const newData = docSnapshot.data();
        
        // Ensure the data structure matches our expected format
        if (newData.data) {
          const processedData = {};
          for (const [student, attendance] of Object.entries(newData.data)) {
            if (Array.isArray(attendance)) {
              processedData[student] = attendance;
            } else {
              // Convert non-array data to array format
              processedData[student] = new Array((newData.subjects || []).length).fill(false);
            }
          }
          updateTableWithChanges({...newData, data: processedData});
        } else {
          updateTableWithChanges(newData);
        }
        
        // Update last modified info
        const lastUpdated = newData.updatedAt ? new Date(newData.updatedAt).toLocaleString() : 'Unknown';
        lastUpdatedInfo.textContent = `Last updated: ${lastUpdated}`;
        
        // Add pulse animation to table
        const table = $('attendance-table');
        table.classList.add('pulse-animation');
        setTimeout(() => table.classList.remove('pulse-animation'), 500);
      } else {
        // Document doesn't exist, show empty table
        const subjects = subjectsByDay[day] || [];
        buildTable(subjects);
        lastUpdatedInfo.textContent = 'No data saved yet';
      }
      
      // Update status back to connected after a delay
      setTimeout(() => {
        if (autoUpdateEnabled) {
          updateStatusIndicator('connected', 'ðŸŸ¢ Live Updates Active');
        }
      }, 1000);
    },
    (error) => {
      console.error('Auto-update listener error:', error);
      updateStatusIndicator('error', 'ðŸ”´ Connection Error');
      
      // Try to reconnect after 5 seconds
      setTimeout(() => {
        if (autoUpdateEnabled) {
          startAutoUpdate();
        }
      }, 5000);
    }
  );
} catch (error) {
  console.error('Failed to start auto-update:', error);
  updateStatusIndicator('error', 'ðŸ”´ Failed to Start Updates');
}
  }

  function stopAutoUpdate() {
    if (currentDocListener) {
      currentDocListener();
      currentDocListener = null;
    }
  }

function updateTableWithChanges(newData) {
  const subjectIndex = parseInt(subjectSelect.value, 10);
  const selectedSubject = (subjectsByDay[daySelect.value] || [])[subjectIndex];
  if (!selectedSubject) return;

  // Update checkboxes based on new data
  document.querySelectorAll('#attendance-body tr').forEach(row => {
    const student = row.cells[0].textContent;
    const checkbox = row.cells[1].querySelector('input[type="checkbox"]');
    
    if (newData.data && newData.data[student] && Array.isArray(newData.data[student])) {
      // Ensure the array has enough elements
      if (subjectIndex < newData.data[student].length) {
        checkbox.checked = newData.data[student][subjectIndex] || false;
      } else {
        checkbox.checked = false;
      }
      
      // Add visual feedback for updated cells
      const cell = checkbox.parentElement;
      cell.classList.add('updated-cell');
      setTimeout(() => cell.classList.remove('updated-cell'), 2000);
    }
  });
}





  // Start auto-update when day/date changes
  daySelect.addEventListener('change', () => { 
    populateSubjectSelect(); 
    startAutoUpdate();
  });
  
  dateSelect.addEventListener('change', () => { 
    populateSubjectSelect(); 
    startAutoUpdate();
  });

  // Start auto-update when saved record is selected
  savedDates.addEventListener('change', () => {
    const recordId = savedDates.value;
    if (!recordId) return;
    const [day, date] = recordId.split('_');
    daySelect.value = day;
    dateSelect.value = date;
    populateSubjectSelect();
    startAutoUpdate();
  });

  /*************************************
   * Auth state
   *************************************/
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userDocRef);
        if (!userSnap.exists()) {
          currentRole = null;
          userRoleInfo.textContent = `Signed in as: ${user.email} (UID: ${user.uid})`;
          missingRole.style.display = '';
          missingRole.innerHTML = `<strong>No role assigned</strong><br/>Create <code>users/${user.uid}</code> with fields <code>email</code>, <code>role</code> ("teacher" or "viewer"), and <code>studentKey</code> (exactly as in students[]).<br/><br/>
          <small>If you are an admin, you can try creating here (rules may block):</small>
          <div style="margin-top:8px">
            <select id="role-to-create"><option value="viewer">viewer</option><option value="teacher">teacher</option></select>
            <input id="studentKey-to-create" placeholder="e.g., R23XV1M6701 - Addanki Harshitha" style="min-width:340px"/>
            <button id="create-role-doc">Create role doc (attempt)</button>
          </div>`;

          document.getElementById('create-role-doc').addEventListener('click', async () => {
            const chosen = document.getElementById('role-to-create').value;
            const skey = document.getElementById('studentKey-to-create').value || null;
            try {
              await setDoc(doc(db, 'users', user.uid), { email: user.email, role: chosen, studentKey: skey });
              missingRole.className = 'success';
              missingRole.textContent = `Role document created as '${chosen}'. Reloading...`;
              setTimeout(() => location.reload(), 800);
            } catch (err) {
              console.error(err);
              missingRole.className = 'error';
              missingRole.innerHTML = `Failed to create role doc: <code>${err.code || err.message}</code><br/>Add the document manually in the Firebase Console.`;
            }
          });

          showApp();
          return;
        }

        currentRole = userSnap.data().role;
        userRoleInfo.textContent = `Signed in as: ${user.email} â€” role: ${currentRole}`;
        missingRole.style.display = 'none';
        loginFeedback.innerHTML = '';
        showApp();

        // If token is present in URL (student flow), try auto-scan immediately
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
          await handleScanFlow(urlToken);
        }
      } catch (err) {
        console.error('Error fetching user role:', err);
        loginFeedback.innerHTML = `<div class="error">Failed to fetch role: ${err.message || err.code}</div>`;
        showLogin();
      }
    } else {
      currentRole = null;
      userRoleInfo.textContent = '';
      missingRole.style.display = 'none';
      stopAutoUpdate(); // Stop auto-update when logged out
      showLogin();
    }
  });

  function showLogin() {
    loginSection.classList.remove('hidden');
    attendanceSection.classList.add('hidden');
    loginTroubleshoot.style.display = 'none';
    stopAutoUpdate();
  }

  function showApp() {
    loginSection.classList.add('hidden');
    attendanceSection.classList.remove('hidden');

    populateDayDropdown();
    dateSelect.value = new Date().toISOString().split('T')[0];
    buildTable(subjectsByDay['Monday']);
    loadSavedDates();
    populateSubjectSelect();

    if (currentRole === 'viewer') {
      addClassSection.style.display = 'none';
      teacherButtons.style.display = 'none';
      daySelect.disabled = true;
      dateSelect.disabled = true;
      qrSessionBox.style.display = 'none';
      // Viewers can still benefit from auto-updates
      toggleAutoUpdateBtn.style.display = '';
    } else {
      addClassSection.style.display = '';
      teacherButtons.style.display = '';
      daySelect.disabled = false;
      dateSelect.disabled = false;
      qrSessionBox.style.display = '';
      toggleAutoUpdateBtn.style.display = '';
    }

    // Start auto-update for the current selection
    startAutoUpdate();
  }

  /*************************************
   * UI actions (login etc.)
   *************************************/
  loginBtn.addEventListener('click', async () => {
    const email = (document.getElementById('username').value || '').trim();
    const pass = (document.getElementById('password').value || '').trim();
      // const captchaResponse = grecaptcha.getResponse();
      // if (!captchaResponse) {
      //  loginFeedback.innerHTML = `<div class="error">Please complete the CAPTCHA.</div>`;
      //   return;
      // }
    if (!email || !pass) {
      loginTroubleshoot.style.display = '';
      loginFeedback.innerHTML = `<div class="error">Please enter both email and password.</div>`;
      return;
    }
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
      loginFeedback.innerHTML = `<div class="error">Please enter a valid email address.</div>`;
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      loginFeedback.innerHTML = `<div class="success">Signed in successfully.</div>`;
      loginTroubleshoot.style.display = 'none';
    } catch (e) {
      console.error('firebase auth error:', e);
      loginTroubleshoot.style.display = '';
      const code = e.code || e.message || 'unknown';
      let message = '';
      switch (code) {
        case 'auth/invalid-email': message = 'Invalid email format.'; break;
        case 'auth/user-disabled': message = 'This user account has been disabled.'; break;
        case 'auth/user-not-found': message = 'No user found for this email.'; break;
        case 'auth/wrong-password':
        case 'auth/invalid-login-credentials': message = 'Wrong password.'; break;
        case 'auth/too-many-requests': message = 'Too many failed attempts. Try again later.'; break;
        default: message = e.message || String(e);
      }
      loginFeedback.innerHTML = `<div class="error"><strong>Sign-in failed</strong>: ${message}<br/><small>Error code: ${code}</small></div>`;
    }
  });

  forgotBtn.addEventListener('click', async () => {
    const email = (document.getElementById('username').value || '').trim();
    if (!email) {
      loginFeedback.innerHTML = `<div class="notice">Enter your email and click "Forgot password".</div>`;
      return;
    }
    try {
      await sendPasswordResetEmail(auth, email);
      loginFeedback.innerHTML = `<div class="success">Password reset email sent to ${email}.</div>`;
    } catch (e) {
      console.error('password reset error', e);
      loginFeedback.innerHTML = `<div class="error">Failed to send reset email: ${e.code || e.message}</div>`;
    }
  });

  logoutBtn.addEventListener('click', async () => {
    try {
      stopAutoUpdate();
      await signOut(auth);
      $("username").value = '';
      $("password").value = '';
      tbody.innerHTML = '';
      tableHeader.innerHTML = '';
      savedDates.innerHTML = '<option value="">-- Select Saved Record --</option>';
      currentRole = null;
      userRoleInfo.textContent = '';
      missingRole.style.display = 'none';
      lastUpdatedInfo.textContent = '';
      alert('You have been logged out.');
    } catch (e) {
      console.error('Logout failed:', e);
      alert('Failed to log out. Please try again.');
    }
  });

  /*************************************
   * Attendance table with Select All functionality
   *************************************/
  addClassBtn.addEventListener('click', addClass);
  const removeClassBtn = document.getElementById('remove-class-btn');
removeClassBtn.addEventListener('click', removeClass);

function removeClass() {
  if (currentRole === 'viewer') return;

  const day = daySelect.value;
  const subjectIndex = parseInt(subjectSelect.value, 10);
  const subjects = subjectsByDay[day];

  if (isNaN(subjectIndex) || subjectIndex < 0 || subjectIndex >= subjects.length) {
    alert('Please select a subject to remove');
    return;
  }

  const subjectName = subjects[subjectIndex];
  if (!confirm(`Are you sure you want to remove "${subjectName}" from ${day}?`)) {
    return;
  }

  // Remove subject from timetable
  subjects.splice(subjectIndex, 1);

  // Rebuild table with existing attendance data (without this subject)
  const existingData = {};
  document.querySelectorAll('#attendance-body tr').forEach(row => {
    const student = row.cells[0].textContent;
    existingData[student] = [];
    for (let i = 1; i < row.cells.length; i++) {
      existingData[student].push(row.cells[i].firstChild.checked);
    }
  });

  buildTable(subjects, existingData);
  populateSubjectSelect();

  alert(`Subject "${subjectName}" removed successfully`);
}

  saveBtn.addEventListener('click', saveAttendance);
  exportBtn.addEventListener('click', exportCSV);
  saveBtn2.addEventListener('click', saveAttendance);
  exportBtn2.addEventListener('click', exportCSV);

  function populateDayDropdown() {
    daySelect.innerHTML = '';
    Object.keys(subjectsByDay).forEach(day => {
      const option = document.createElement('option');
      option.value = day;
      option.textContent = day;
      daySelect.appendChild(option);
    });
  }

  function populateSubjectSelect() {
    subjectSelect.innerHTML = '';
    const subjects = subjectsByDay[daySelect.value] || [];
    subjects.forEach((s, i) => {
      const opt = document.createElement('option');
      opt.value = String(i); // store index
      opt.textContent = s;
      subjectSelect.appendChild(opt);
    });
  }

function buildTable(subjects, existingData = {}) {
  // Clear existing content
  tableHeader.innerHTML = '';
  tbody.innerHTML = '';

  // Get selected subject
  const subjectIndex = parseInt(subjectSelect.value, 10);
  const subjectName = subjects[subjectIndex];
  if (!subjectName) return;

  // Build header (only selected subject)
  let headerHTML = '<th>Students</th>';
headerHTML += `
  <th class="subject-header">
    ${subjectName}
    <button class="select-all-btn" 
            data-subject-index="${subjectIndex}" 
            onclick="toggleSelectAll(${subjectIndex})">
      Select All
    </button>
  </th>`;
tableHeader.innerHTML = headerHTML;


  // Build body rows
  students.forEach(student => {
    const row = document.createElement('tr');
    
    // Get attendance status for this specific subject
    let isPresent = false;
    if (existingData[student] && Array.isArray(existingData[student])) {
      // Ensure the array has enough elements
      if (subjectIndex < existingData[student].length) {
        isPresent = existingData[student][subjectIndex];
      }
    }
    
    const disabled = currentRole === 'viewer' ? 'disabled' : '';
    row.innerHTML = `
      <td>${student}</td>
      <td><input type="checkbox" ${isPresent ? 'checked' : ''} ${disabled} 
           data-student="${student}" data-subject-index="${subjectIndex}"></td>
    `;
    tbody.appendChild(row);
  });

  updateSelectAllButtons();

}







  // Global function for select all buttons (needs to be accessible from onclick)
 window.toggleSelectAll = function(subjectIndex) {
  const checkboxes = document.querySelectorAll(
    `#attendance-body input[type="checkbox"][data-subject-index="${subjectIndex}"]`
  );
  const button = document.querySelector(
    `.select-all-btn[data-subject-index="${subjectIndex}"]`
  );

  const allSelected = Array.from(checkboxes).every(cb => cb.checked);

  checkboxes.forEach(cb => cb.checked = !allSelected);

  updateSelectAllButton(button, !allSelected);
};


  function updateSelectAllButtons() {
    if (currentRole !== 'teacher') return;
    
    document.querySelectorAll('.select-all-btn').forEach(button => {
      const subjectIndex = parseInt(button.getAttribute('data-subject-index'));
      const checkboxes = document.querySelectorAll(`#attendance-body input[type="checkbox"][data-subject-index="${subjectIndex}"]`);
      const allSelected = Array.from(checkboxes).every(cb => cb.checked);
      
      updateSelectAllButton(button, allSelected);
    });
  }

  function updateSelectAllButton(button, allSelected) {
    if (allSelected) {
      button.textContent = 'Deselect All';
      button.classList.add('deselect');
    } else {
      button.textContent = 'Select All';
      button.classList.remove('deselect');
    }
  }

  // Update select all buttons when individual checkboxes are clicked
  document.addEventListener('change', (e) => {
    if (e.target.type === 'checkbox' && e.target.hasAttribute('data-subject-index') && currentRole === 'teacher') {
      updateSelectAllButtons();
    }
  });
// 1. Update the subjectSelect event listener to rebuild the table with current data
subjectSelect.addEventListener('change', () => {
  const day = daySelect.value;
  const date = dateSelect.value;
  if (!day || !date) return;
  
  const docId = `${day}_${date}`;
  
  // Fetch data from Firestore
  getDoc(doc(db, 'attendance', docId)).then(docSnap => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      const subjects = subjectsByDay[day] || [];
      buildTable(subjects, data.data || {});
    } else {
      // No data exists for this date, show empty table
      const subjects = subjectsByDay[day] || [];
      buildTable(subjects, {});
    }
  }).catch(error => {
    console.error('Error fetching data:', error);
    const subjects = subjectsByDay[day] || [];
    buildTable(subjects, {});
  });
});

function processAttendanceData(data, subjects) {
  const processedData = {};
  const subjectCount = subjects.length;
  
  // Process each student's data
  for (const [student, attendance] of Object.entries(data)) {
    if (Array.isArray(attendance)) {
      // If the attendance array is shorter than the number of subjects, extend it
      if (attendance.length < subjectCount) {
        processedData[student] = [...attendance, ...new Array(subjectCount - attendance.length).fill(false)];
      } else {
        processedData[student] = attendance;
      }
    } else {
      // If it's not an array, initialize with all false values
      processedData[student] = new Array(subjectCount).fill(false);
    }
  }
  
  return processedData;
}

// 1. Modify the saveAttendance function to handle multiple subjects properly
// 1. Modify the saveAttendance function to match the desired structure
async function saveAttendance() {
  if (currentRole !== 'teacher') { 
    alert('Only teachers can save.'); 
    return; 
  }
  const day = daySelect.value;
  const date = dateSelect.value;
  if (!date) { 
    alert('Please choose a date'); 
    return; 
  }
  const docId = `${day}_${date}`;

  // Get all subjects for this day
  const allSubjects = subjectsByDay[day] || [];
  const subjectIndex = parseInt(subjectSelect.value, 10);
  const subjectName = allSubjects[subjectIndex];
  if (!subjectName) { 
    alert('Select a subject'); 
    return; 
  }

  // Get existing data first
  let existingData = {};
  let existingSubjects = [];
  try {
    const docSnap = await getDoc(doc(db, 'attendance', docId));
    if (docSnap.exists()) {
      const data = docSnap.data();
      existingData = data.data || {};
      existingSubjects = data.subjects || [];
    }
  } catch (e) {
    console.error('Error fetching existing data:', e);
  }

  // If subjects array doesn't match the current day's subjects, update it
  if (JSON.stringify(existingSubjects) !== JSON.stringify(allSubjects)) {
    existingSubjects = [...allSubjects];
  }

  // Update attendance data for the selected subject
  document.querySelectorAll('#attendance-body tr').forEach(row => {
    const student = row.cells[0].textContent;
    const checked = row.cells[1].firstChild.checked;
    
    // Initialize student data if it doesn't exist
    if (!existingData[student]) {
      existingData[student] = new Array(allSubjects.length).fill(false);
    }
    
    // Ensure the array has the correct length
    if (existingData[student].length !== allSubjects.length) {
      // If length doesn't match, create a new array with correct length
      const newAttendance = new Array(allSubjects.length).fill(false);
      // Copy existing values if possible
      for (let i = 0; i < Math.min(existingData[student].length, allSubjects.length); i++) {
        newAttendance[i] = existingData[student][i];
      }
      existingData[student] = newAttendance;
    }
    
    // Update only the selected subject
    existingData[student][subjectIndex] = checked;
  });

  try {
    await setDoc(doc(db, 'attendance', docId), { 
      subjects: allSubjects,   // Save all subjects for this day
      data: existingData, 
      day, 
      date, 
      updatedBy: auth.currentUser?.uid || null, 
      updatedAt: Date.now() 
    }, { merge: true });

    alert(`Attendance saved for ${subjectName} on ${day} (${date})`);
    await loadSavedDates();
  } catch (e) {
    console.error(e);
    alert('Failed to save (check Firestore rules).');
  }
}




 async function loadSavedDates() {
  savedDates.innerHTML = '<option value="">-- Select Saved Record --</option>';
  try {
    const querySnapshot = await getDocs(collection(db, 'attendance'));
    const records = [];

    querySnapshot.forEach(docSnap => {
      records.push(docSnap.id);
    });

    // Extract the date part from IDs like "Monday_2025-08-20" and sort in descending order
    records.sort((a, b) => {
      const dateA = new Date(a.split('_')[1]);
      const dateB = new Date(b.split('_')[1]);
      return dateB - dateA;
    });

    records.forEach(recordId => {
      const option = document.createElement('option');
      option.value = recordId;
      option.textContent = recordId;
      savedDates.appendChild(option);
    });
  } catch (e) {
    console.error(e);
    alert('Failed to load saved records (check Firestore rules).');
  }
}


  function addClass() {
    if (currentRole === 'viewer') return;
    const input = document.getElementById('new-class-name');
    const newClass = (input.value || '').trim();
    if (!newClass) { alert('Please enter a class name'); return; }

    const day = daySelect.value;
    const subjects = subjectsByDay[day];
    if (subjects.includes(newClass)) { alert('This class already exists for today.'); return; }

    const existingData = {};
    document.querySelectorAll('#attendance-body tr').forEach(row => {
      const student = row.cells[0].textContent;
      existingData[student] = [];
      for (let i = 1; i < row.cells.length; i++) {
        existingData[student].push(row.cells[i].firstChild.checked);
      }
    });

    subjects.push(newClass);
    buildTable(subjects, existingData);
    input.value = '';
    populateSubjectSelect();
  }

  async function exportCSV() {
    if (currentRole !== 'teacher') { alert('Only teachers can export.'); return; }
    const day = daySelect.value;
    const date = dateSelect.value;
    const docId = `${day}_${date}`;
    try {
      const docSnap = await getDoc(doc(db, 'attendance', docId));
      if (!docSnap.exists()) { alert('No data found for this date'); return; }
      const saved = docSnap.data();
      let csvContent = `Date,${date},Day,${day}\n`;
      csvContent += 'Student,' + (saved.subjects || []).join(',') + '\n';
      Object.keys(saved.data || {}).forEach(student => {
        csvContent += student + ',' + (saved.data[student] || []).map(p => p ? 'Present' : 'Absent').join(',') + '\n';
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Attendance_${day}_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error(e);
      alert('Failed to export (check Firestore rules).');
    }
  }

  /*************************************
   * QR + Geolocation session (teacher)
   *************************************/
  setClassHereBtn.addEventListener('click', () => {
  if (!navigator.geolocation) {
    alert('Geolocation is not supported by your browser');
    return;
  }

  // Show loading state
  setClassHereBtn.disabled = true;
  setClassHereBtn.textContent = 'Detecting location...';

  const options = {
    enableHighAccuracy: true,
    timeout: 30000, // 30 seconds timeout
    maximumAge: 30000  // Accept cached position up to 30 seconds old
  };

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      CLASS_LAT = pos.coords.latitude;
      CLASS_LON = pos.coords.longitude;
      
      // Show success message with coordinates
      scanStatus.className = 'success';
      scanStatus.innerHTML = `Classroom location set successfully!<br>
        Latitude: ${CLASS_LAT.toFixed(6)}<br>
        Longitude: ${CLASS_LON.toFixed(6)}`;
      
      // Reset button state
      setClassHereBtn.disabled = false;
      setClassHereBtn.textContent = 'Use my current location';
    },
    (err) => {
      // Handle errors appropriately
      let errorMessage = 'Failed to get location: ';
      switch(err.code) {
        case err.PERMISSION_DENIED:
          errorMessage += 'Permission denied. Please enable location services.';
          break;
        case err.POSITION_UNAVAILABLE:
          errorMessage += 'Location information unavailable.';
          break;
        case err.TIMEOUT:
          errorMessage += 'Location request timed out.';
          break;
        default:
          errorMessage += err.message;
      }
      
      scanStatus.className = 'error';
      scanStatus.innerHTML = errorMessage;
      
      // Reset button state
      setClassHereBtn.disabled = false;
      setClassHereBtn.textContent = 'Use my current location';
    },
    options
  );
});

  startQrBtn.addEventListener('click', async () => {
    if (currentRole !== 'teacher') { alert('Only teachers can start sessions.'); return; }

    const subjectIndex = parseInt(subjectSelect.value, 10);
    const subjectName = (subjectsByDay[daySelect.value] || [])[subjectIndex];
    if (!subjectName) { alert('Select a subject'); return; }

    const radiusMeters = parseInt(radiusInput.value || CLASS_RADIUS_METERS_DEFAULT, 10);
    const expiresInMinutes = parseInt(expireMinsInput.value || 3, 10);
    const day = daySelect.value;
    const date = dateSelect.value;
    if (!date) { alert('Choose a date'); return; }

    // Generate a random token
    const token = Math.random().toString(36).slice(2) + Date.now().toString(36);
    const expiresAt = Date.now() + expiresInMinutes * 60 * 1000;

    const sessionDoc = {
      token,
      day,
      date,
      subjectIndex,
      subjectName,
      classLat: CLASS_LAT,
      classLon: CLASS_LON,
      radiusMeters,
      createdBy: auth.currentUser?.uid || null,
      createdAt: serverTimestamp(),
      expiresAt
    };

    try {
      await setDoc(doc(db, 'attendance_sessions', token), sessionDoc);
      activeSessionToken = token;
      activeSessionRef = doc(db, 'attendance_sessions', token);
      renderQRCode(token);
      endQrBtn.style.display = '';
      qrBox.classList.remove('hidden');
      qrInfo.innerHTML = `<div><strong>Session:</strong> ${day} ${date} â€” <code class="kbd">${subjectName}</code><br/>Expires at: ${new Date(expiresAt).toLocaleTimeString()}</div>`;
    } catch (e) {
      console.error(e);
      alert('Failed to start session (check Firestore rules).');
    }
  });

  endQrBtn.addEventListener('click', async () => {
    if (!activeSessionToken) return;
    try {
      // Soft-end by setting expiresAt = now
      const ref = doc(db, 'attendance_sessions', activeSessionToken);
      await setDoc(ref, { expiresAt: Date.now() }, { merge: true });
    } catch (e) { console.warn(e); }
    activeSessionToken = null;
    activeSessionRef = null;
    endQrBtn.style.display = 'none';
    qrBox.classList.add('hidden');
    $("qrcode").innerHTML = '';
    qrInfo.textContent = '';
  });

  function renderQRCode(token) {
    const url = `${window.location.origin}${window.location.pathname}?token=${encodeURIComponent(token)}`;
    $("qrcode").innerHTML = '';
    qrcode = new QRCode("qrcode", { text: url, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
  }

  /*************************************
   * Student scan flow
   *************************************/
   function getDistanceKm(lat1, lon1, lat2, lon2) {
      var R = 6371;
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLon = (lon2 - lon1) * Math.PI / 180;
      var a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * Math.PI / 180) *
              Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
  
  async function markAttendance() {
  try {
    const qrData = JSON.parse(document.getElementById("qrInput").value);

    // 1. Verify QR session
    const sessionDoc = await db.collection("attendance_sessions").doc(qrData.session_id).get();
    if (!sessionDoc.exists) return alert("Invalid QR");

    const session = sessionDoc.data();
    if (session.expires_at.toDate() < new Date()) return alert("QR expired");

    // 2. Check location
    if (!navigator.geolocation) return alert("Geolocation not supported");

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const dist = getDistanceKm(
        pos.coords.latitude,
        pos.coords.longitude,
        17.385044,
        78.486671
      );
      if (dist > 0.03) return alert("Not in classroom");

      const uid = firebase.auth().currentUser.uid;

      // 3. Prevent duplicates: check if already marked
      const existing = await db.collection("attendance").where("session_id", "==", qrData.session_id)
        .where("uid", "==", uid)
        .get();

      if (!existing.empty) {
        return alert("Attendance already marked");
      }

      // 4. Mark attendance
      await db.collection("attendance").add({
        session_id: qrData.session_id,
        uid: uid,
        lat: pos.coords.latitude,
        lon: pos.coords.longitude,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("Attendance marked");
    });
  } catch (err) {
    console.error(err);
    alert("Error marking attendance");
  }
}

  async function handleScanFlow(token) {
  scanStatus.classList.remove('hidden');
  scanStatus.innerHTML = `QR token detected. Verifying your locationâ€¦`;

  // 1) Load session
  const sessSnap = await getDoc(doc(db, 'attendance_sessions', token));
  if (!sessSnap.exists()) {
    scanStatus.className = 'error';
    scanStatus.innerHTML = `Invalid or expired session.`;
    return;
  }

  const sess = sessSnap.data();
  if (Date.now() > (sess.expiresAt || 0)) {
    scanStatus.className = 'error';
    scanStatus.innerHTML = `This session has expired.`;
    return;
  }

  // 2) Get studentKey
  const uid = auth.currentUser?.uid;
  const uref = await getDoc(doc(db, 'users', uid));
  const udata = uref.exists() ? uref.data() : null;
  const studentKey = udata?.studentKey;
  
  if (!studentKey || !students.includes(studentKey)) {
    scanStatus.className = 'error';
    scanStatus.innerHTML = `Your profile is missing a valid <code>studentKey</code>.`;
    return;
  }

  // 3) Get location with better error handling
  if (!navigator.geolocation) {
    scanStatus.className = 'error';
    scanStatus.innerHTML = `Geolocation not supported on this device.`;
    return;
  }

  const locationOptions = {
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 0
  };

  scanStatus.innerHTML = `Detecting your location (this may take a few seconds)...`;

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const accuracy = pos.coords.accuracy; // Accuracy in meters
      const distM = distanceMeters(lat, lon, sess.classLat, sess.classLon);

      // Check if accuracy is good enough (within 50m)
      if (accuracy > 50) {
        scanStatus.className = 'error';
        scanStatus.innerHTML = `Your location accuracy is too low (${Math.round(accuracy)}m). 
          Please move to an area with better GPS signal.`;
        return;
      }

      if (distM <= (sess.radiusMeters || 35)) {
        try {
          await markPresentForStudent(studentKey, sess.day, sess.date, sess.subjectIndex);
          
          await setDoc(doc(db, 'attendance_scans', `${token}_${uid}`), {
            token, uid, studentKey, lat, lon, accuracy, at: Date.now()
          });

          scanStatus.className = 'success';
          scanStatus.innerHTML = `Attendance marked for <strong>${sess.subjectName}</strong>!<br>
            Distance from class: ~${Math.round(distM)}m`;
            
          // The auto-update system will automatically refresh the table
        } catch (e) {
          console.error(e);
          scanStatus.className = 'error';
          scanStatus.innerHTML = `Failed to mark attendance: ${e.message || e}`;
        }
      } else {
        scanStatus.className = 'error';
        scanStatus.innerHTML = `You're too far from classroom (${Math.round(distM)}m away). 
          Maximum allowed: ${sess.radiusMeters || 35}m.`;
      }
    },
    (err) => {
      let errorMsg = 'Location error: ';
      switch(err.code) {
        case err.PERMISSION_DENIED:
          errorMsg += 'Permission denied. Please enable location services in your browser settings.';
          break;
        case err.POSITION_UNAVAILABLE:
          errorMsg += 'Location unavailable. Check your internet/GPS connection.';
          break;
        case err.TIMEOUT:
          errorMsg += 'Location request timed out. Please try again in an area with better signal.';
          break;
        default:
          errorMsg += err.message;
      }
      scanStatus.className = 'error';
      scanStatus.innerHTML = errorMsg;
    },
    locationOptions
  );
}

  async function markPresentForStudent(studentKey, day, date, subjectIndex) {
    const docId = `${day}_${date}`;
    const attRef = doc(db, 'attendance', docId);
    const attSnap = await getDoc(attRef);

    // Ensure subjects array is from timetable
    const subjects = subjectsByDay[day] || [];
    const blankRow = subjects.map(() => false);

    let data = {};
    if (attSnap.exists()) {
      const saved = attSnap.data();
      // If a custom subjects set was saved that day, respect it
      const inUseSubjects = Array.isArray(saved.subjects) && saved.subjects.length ? saved.subjects : subjects;
      // Expand if needed
      const rowTemplate = inUseSubjects.map(() => false);

      data = saved.data || {};
      // Normalize existing rows
      Object.keys(data).forEach(k => {
        if (!Array.isArray(data[k]) || data[k].length !== inUseSubjects.length) {
          const arr = rowTemplate.slice();
          (data[k] || []).forEach((v, i) => { if (i < arr.length) arr[i] = !!v; });
          data[k] = arr;
        }
      });

      if (!data[studentKey]) data[studentKey] = rowTemplate.slice();
      data[studentKey][subjectIndex] = true;

      await setDoc(attRef, {
        subjects: inUseSubjects,
        data,
        day, date,
        updatedBy: auth.currentUser?.uid || null,
        updatedAt: Date.now()
      });
    } else {
      // New doc
      data[studentKey] = blankRow.slice();
      data[studentKey][subjectIndex] = true;

      await setDoc(attRef, {
        subjects,
        data,
        day, date,
        updatedBy: auth.currentUser?.uid || null,
        updatedAt: Date.now()
      });
    }
  }

  function distanceMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI/180;
    const dLon = (lon2 - lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  /*************************************
   * Token in URL (student deepâ€‘link)
   *************************************/
  // If the user logs in after opening the link, we already handle it in onAuthStateChanged.
  // If the user is already logged in and opens a token link, handle immediately:
  (async function immediateTokenCheck() {
    const token = new URLSearchParams(window.location.search).get('token');
    if (token && auth.currentUser) {
      await handleScanFlow(token);
    }
  })();

</script>
</body>
</html>
