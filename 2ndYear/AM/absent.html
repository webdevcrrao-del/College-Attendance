<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absent Students — View & Download</title>
  <!-- Use compat builds to avoid module/import issues in sandbox -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body{font-family:Segoe UI,system-ui,-apple-system,Arial;margin:0;background:#f5f7fa}
    header{background:#2c3e50;color:#fff;padding:16px;text-align:center}
    .container{max-width:1000px;margin:24px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:0.95rem}
    select,input[type=date]{padding:8px;border-radius:6px;border:1px solid #d1d5db}
    button{padding:8px 12px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    button.secondary{background:#6b7280}
    button.danger{background:#ef4444}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border:1px solid #e5e7eb;padding:10px;text-align:left}
    th{background:#374151;color:#fff}
    .muted{color:#6b7280}
    .error{color:#b91c1c;margin-top:10px}
    .info{color:#064e3b;margin-top:10px}
    pre{background:#0f172a;color:#e6eef8;padding:10px;border-radius:6px;overflow:auto}
  </style>
</head>
<body>
<header>
  <h1>Absent Students — View & Download</h1>
</header>

<div class="container">
  <div class="row">
    <label>Start: <input id="start-date" type="date"></label>
    <label>End: <input id="end-date" type="date"></label>
    <label>Day:
      <select id="day-select">
        <option value="All">All</option>
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
      </select>
    </label>
    <label>Class: <select id="class-select"></select></label>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="view-btn">View Report</button>
    <button id="download-btn">Download CSV</button>
    <button id="sample-btn" class="secondary">Load Sample</button>
    <div id="auth-area" style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="email" type="text" placeholder="email" style="width:180px;padding:6px;border-radius:6px;border:1px solid #d1d5db">
      <input id="password" type="password" placeholder="password" style="width:140px;padding:6px;border-radius:6px;border:1px solid #d1d5db">
      <button id="signin-btn" class="secondary">Sign in</button>
      <button id="signout-btn" class="secondary" style="display:none">Sign out</button>
    </div>
  </div>

  <div id="messages" style="margin-top:12px"></div>

  <table id="report-table" style="display:none;">
  <thead>
    <tr>
      <th>Date</th>
      <th>Status</th>
      <th>Absent Count</th>
      <th>Absent Students</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  <h3 style="margin-top:18px">Debug / Console</h3>
  <pre id="debug-output">No actions yet.</pre>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
  apiKey: "AIzaSyCIMDTiVKHWGyD0OVZbYtL3QB_FkDrMnrQ",
  authDomain: "ndyearam-4a229.firebaseapp.com",
  projectId: "ndyearam-4a229",
  storageBucket: "ndyearam-4a229.firebasestorage.app",
  messagingSenderId: "847736482794",
  appId: "1:847736482794:web:1c3473c2a07af6073da093",
  measurementId: "G-PD1EN4F89Q"
};

  if (!firebase.apps || !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Full students list (copied from index10.html)
  const students = [
  "24XV1M7601-AKOLE DHRUV KUMAR",
  "24XV1M7602-BOMMALATA KAILASH VINAYAK",
  "24XV1M7603-CHERUKURI SAHAS",
  "24XV1M7604-CHIRUVOLU NEHA SREE SANTHI",
  "24XV1M7605-GADI KEERTHI PRAVALLIKA",
  "24XV1M7606-GOPU DANNY PRAJWAL REDDY",
  "24XV1M7607-KATTA ANISH",
  "24XV1M7608-KAYALA DHURVISREE NAIDU",
  "24XV1M7609-PALLAGANI LALITHA MANOHAR",
  "24XV1M7610-PALLE LAXMINIVAS REDDY",
  "24XV1M7611-PODDUTURI DHARANIVED REDDY",
  "24XV1M7612-SANKU VEERA NAGA HARINI",
  "24XV1M7613-TEJAS SATYANARAYANA",
  "24XV1M7614-VENIGALLA SAI TEJA",
  "24XV1M7615-GANNAVARAPU VENKATA KEDAR",
  "24XV1M7616-PANANGIPALLI LAKSHMI CHAITRA",
  "24XV1M7617-CHINTAGUNTI ASHIKA",
  "24XV1M7618-NOHITH SAI SINGAM",
  "24XV1M7619-THAMMERA SRIAMSHU KUMAR",
  "24XV1M7620-BHOGADI SATHWIK",
  "24XV1M7621-KAMAREDDY KIRAN KUMAR REDDY",
  "24XV1M7622-SHOURYA PRATAP SINGH",
  "24XV1M7623-GOKA NEERAJ",
  "24XV1M7624-BOORA RAJESH",
  "24XV1M7625-LAKKADI SHIVA SAI REDDY",
  "24XV1M7626-PILLARISETTY ABHIRAM",
  "24XV1M7627-KOUKUNTLA SHIVANI",
  "24XV1M7628-BOMMANA MITRA VINDA",
  "24XV1M7629-YENDAPALLY VIDHATHRI",
  "24XV1M7630-MUTHYALA DINESH KUMAR REDDY",
  "24XV1M7631-EDIGA GOUTHAM GOUD",
  "24XV1M7632-GUDARI MANOHAR"
];


 const subjectsByDay = {
    'Monday': [
    'ATCD',
    'DBMS',
    'OS',
    'SE',
    'AI',
    'CONM',
    'NODEJS',
    'OS Lab',
    'RTP',
    'ASSIGNMENT'
  ],
    'Tuesday': [
    'ATCD',
    'DBMS',
    'OS',
    'SE',
    'AI',
    'CONM',
    'NODEJS',
    'OS Lab',
    'RTP',
    'ASSIGNMENT'
  ],
    'Wednesday': [
    'ATCD',
    'DBMS',
    'OS',
    'SE',
    'AI',
    'CONM',
    'NODEJS',
    'OS Lab',
    'RTP',
    'ASSIGNMENT'
  ],
    'Thursday': [
    'ATCD',
    'DBMS',
    'OS',
    'SE',
    'AI',
    'CONM',
    'NODEJS',
    'OS Lab',
    'RTP',
    'ASSIGNMENT'
  ],
    'Friday': [
    'ATCD',
    'DBMS',
    'OS',
    'SE',
    'AI',
    'CONM',
    'NODEJS',
    'OS Lab',
    'RTP',
    'ASSIGNMENT'
  ],
    'Saturday': [
    'ATCD',
    'DBMS',
    'OS',
    'SE',
    'AI',
    'CONM',
    'NODEJS',
    'OS Lab',
    'RTP',
    'ASSIGNMENT'
  ]
  };

  // DOM
  const daySelect = document.getElementById('day-select');
  const classSelect = document.getElementById('class-select');
  const startInput = document.getElementById('start-date');
  const endInput = document.getElementById('end-date');
  const viewBtn = document.getElementById('view-btn');
  const downloadBtn = document.getElementById('download-btn');
  const sampleBtn = document.getElementById('sample-btn');
  const messages = document.getElementById('messages');
  const debugOutput = document.getElementById('debug-output');
  const reportTable = document.getElementById('report-table');
  const reportTbody = reportTable.querySelector('tbody');
  const signinBtn = document.getElementById('signin-btn');
  const signoutBtn = document.getElementById('signout-btn');
  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');

  function dbg(v){ debugOutput.textContent = typeof v==='string'?v:JSON.stringify(v,null,2); console.log(v); }
  function setMessage(msg, type='info'){ messages.innerHTML = `<div class="${type}">${msg}</div>` }
  function clearMessage(){ messages.innerHTML = '' }

  // Populate class options: if day=All, union of all classes; else classes for that day
  function populateClassOptions(){
    classSelect.innerHTML = '';
    if (daySelect.value === 'All'){
      const set = new Set();
      Object.values(subjectsByDay).forEach(arr => arr.forEach(s=>s && s.trim() && set.add(s)));
      Array.from(set).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; classSelect.appendChild(o); });
    } else {
      (subjectsByDay[daySelect.value] || []).forEach(s=>{ if (!s||!s.trim()) return; const o=document.createElement('option'); o.value=s; o.textContent=s; classSelect.appendChild(o); });
    }
    if (!classSelect.options.length){ const o=document.createElement('option'); o.disabled=true; o.textContent='-- no classes --'; classSelect.appendChild(o); }
  }
  daySelect.addEventListener('change', populateClassOptions);
  // default date values
  startInput.value = new Date().toISOString().split('T')[0];
  endInput.value = new Date().toISOString().split('T')[0];
  populateClassOptions();

  // Auth handlers (optional)
  auth.onAuthStateChanged(u=>{
    if (u){ setMessage(`Signed in: ${u.email||u.uid}`,'info'); signinBtn.style.display='none'; signoutBtn.style.display='inline-block'; }
    else { setMessage('Not signed in (read rules may block access)','info'); signinBtn.style.display='inline-block'; signoutBtn.style.display='none'; }
  });
  signinBtn.addEventListener('click',async()=>{
    try{ await auth.signInWithEmailAndPassword(emailInput.value.trim(), passInput.value); setMessage('Signed in','info'); }catch(e){ dbg(e); setMessage(`Sign-in failed: ${e.message||e.code}`,'error'); }
  });
  signoutBtn.addEventListener('click',async()=>{ try{ await auth.signOut(); setMessage('Signed out','info')}catch(e){ dbg(e); }});

  // helper: weekday name from date
  function weekdayName(dt){ return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][dt.getDay()]; }

  // Fetch absent data for a single date — supports dayFilter and subjectName
  async function fetchForDate(dateStr, dayFilter, subjectName){
    // If dayFilter is specific (not All) we will attempt to read doc with id `${dayFilter}_${dateStr}`
    // If dayFilter === 'All' we query attendance documents where date == dateStr and pick the doc that contains the subjectName (if any)
    const result = { date: dateStr, exists:false, subjectFound:false, absent:[], error:null };
    try{
      if (dayFilter !== 'All'){
        const docId = `${dayFilter}_${dateStr}`;
        const snap = await db.collection('attendance').doc(docId).get();
        if (!snap.exists){ result.exists=false; return result; }
        result.exists = true;
        const saved = snap.data() || {};
        const subjIdx = Array.isArray(saved.subjects) ? saved.subjects.indexOf(subjectName) : -1;
        if (subjIdx === -1) { result.subjectFound=false; return result; }
        result.subjectFound = true;
        // compute absent
        students.forEach(s=>{ const row = (saved.data && saved.data[s]) || []; if (!row[subjIdx]) result.absent.push(s); });
        return result;
      } else {
        // query docs where date == dateStr
        const qsnap = await db.collection('attendance').where('date','==',dateStr).get();
        if (qsnap.empty){ result.exists=false; return result; }
        result.exists = true;
        // find a doc that contains the subjectName
        let found = false;
        for (const doc of qsnap.docs){ const saved = doc.data()||{}; const subjIdx = Array.isArray(saved.subjects)? saved.subjects.indexOf(subjectName) : -1; if (subjIdx !== -1){ found = true; result.subjectFound = true; students.forEach(s=>{ const row = (saved.data&&saved.data[s])||[]; if (!row[subjIdx]) result.absent.push(s); }); break; } }
        return result;
      }
    }catch(err){ dbg(['Error fetching', dateStr, err]); result.error = err.message || String(err); return result; }
  }

  // Iterate date range and collect results — always returns an entry for each calendar date between start and end (inclusive)
  async function fetchAbsentBetween(startDateStr, endDateStr, dayFilter, subjectName){
    const start = new Date(startDateStr + 'T00:00:00');
    const end = new Date(endDateStr + 'T00:00:00');
    if (isNaN(start)||isNaN(end)|| start> end) throw new Error('Invalid date range');
    const rows = [];
    let cur = new Date(start);
    while (cur <= end){
    const dateStr = cur.toLocaleDateString('en-CA');
      // If user selected a specific day and that date's calendar weekday doesn't match the selected day,
      // still attempt to fetch using the selected day name because saved docs are keyed by the teacher's selected day at save-time.
      const res = await fetchForDate(dateStr, dayFilter, subjectName);
      rows.push(res);
      cur.setDate(cur.getDate()+1);
    }
    return rows;
  }

   function renderRows(rows){
  reportTbody.innerHTML = rows.map(r=>{
    let status = r.error 
      ? `ERROR: ${r.error}` 
      : (!r.exists 
        ? 'No record' 
        : (!r.subjectFound ? 'Subject not recorded' : 'OK'));
    
    const absentCount = r.absent && r.absent.length ? r.absent.length : 0;
    const absentHtml = r.absent && r.absent.length 
      ? r.absent.join('<br>') 
      : (r.subjectFound ? 'None' : '-');

    return `<tr>
              <td>${r.date}</td>
              <td>${status}</td>
              <td>${absentCount}</td>
              <td>${absentHtml}</td>
            </tr>`;
  }).join('');
  reportTable.style.display = rows.length ? 'table' : 'none';
}

  function exportCSV(rows){
    // CSV columns: Date,Status,AbsentCount,AbsentStudents
    const lines = [['Date','Status','AbsentCount','AbsentStudents']];
    rows.forEach(r=>{
      const status = r.error ? `ERROR: ${r.error}` : (!r.exists ? 'No record' : (!r.subjectFound ? 'Subject not recorded' : 'OK'));
      const absentList = r.absent && r.absent.length ? r.absent.join('; ') : '';
      const absentCount = r.absent? r.absent.length : 0;
      lines.push([r.date, status, absentCount, absentList]);
    });
    const csv = lines.map(row=> row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `absent_report_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  async function getResults(){
    clearMessage(); dbg('Collecting results...');
    const sd = startInput.value; const ed = endInput.value; const dayFilter = daySelect.value; const subjectName = classSelect.value;
    if (!sd || !ed || !subjectName){ setMessage('Please select start date, end date and a class','error'); return null; }
    try{
      const rows = await fetchAbsentBetween(sd,ed,dayFilter,subjectName);
      dbg(rows);
      return rows;
    }catch(e){ dbg(e); setMessage('Failed: '+ (e.message||e),'error'); return null; }
  }

  viewBtn.addEventListener('click', async ()=>{
    const rows = await getResults(); if (rows) renderRows(rows);
  });
  downloadBtn.addEventListener('click', async ()=>{
    const rows = await getResults(); if (rows) exportCSV(rows);
  });

  // Sample/test case to verify UI without Firestore access
  sampleBtn.addEventListener('click', ()=>{
    clearMessage(); dbg('Loading sample rows');
    const sample = [
      {date:'2025-09-01', exists:true, subjectFound:true, absent:['23XV1M0502 - Amaram Sindhu Reddy','23XV1M0530 - Uppada Enos']},
      {date:'2025-09-02', exists:true, subjectFound:false, absent:[]},
      {date:'2025-09-03', exists:false, subjectFound:false, absent:[]}
    ];
    renderRows(sample);
    setMessage('Sample data loaded — use this to verify view and CSV export.','info');
  });

  // expose helpers for debugging in console
  window.__absent_helpers = { fetchForDate, fetchAbsentBetween, exportCSV };

</script>
</body>
</html>
